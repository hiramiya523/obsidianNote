---
title: 本プロジェクトにおける推奨アプローチ
created: 2025-12-03
updated: 2025-12-03
category: Laravel
tags:
  - laravel
  - php
  - di
  - dependency-injection
  - best-practices
aliases:
  - 推奨アプローチ
  - DI推奨実装
---

# 本プロジェクトにおける推奨アプローチ

## 現状分析

プロジェクトの現状を確認した結果：

1. **48箇所**で`new`による直接インスタンス化が発生
2. 一部で`app()->make()`を使用（不統一）
3. イベントシステムは基本的な設定のみ
4. 循環参照のリスクが存在

## 推奨アプローチ（優先順位順）

### ✅ Phase 1: 必須（最優先）

#### 1. **すべてのサービスをDIコンテナに登録** ⭐⭐⭐
**優先度: 最高**

**理由:**
- 現状の根本的な問題（`new`による直接インスタンス化）を解決
- テストしやすい設計の基盤
- 他の解決策の前提条件

**実装:**
- `ServiceServiceProvider`を作成（既に作成済み）
- `config/app.php`に登録
- すべてのサービスを登録

**影響範囲:**
- 全サービスクラス
- コントローラー（変更不要、自動的にDIで解決される）

**工数:** 中（2-3日）

---

#### 2. **コンストラクタインジェクションへの変更** ⭐⭐⭐
**優先度: 最高**

**理由:**
- DIコンテナ登録とセットで実装すべき
- 依存関係を明示化
- テストでモック注入が可能に

**実装:**
- 各サービスのコンストラクタを変更
- `new Service()` → コンストラクタインジェクション

**影響範囲:**
- `ReservationService`
- `ReservationCommodityService`
- `PaymentBusinessService`
- `DynamicPackageReservationService`
- その他のサービス

**工数:** 中（3-5日）

---

### ✅ Phase 2: 循環参照の解決（必要に応じて）

#### 3. **中間サービスの導入** ⭐⭐
**優先度: 中（循環参照が発生した場合のみ）**

**理由:**
- 循環参照が実際に発生している場合の解決策
- イベント駆動より実装が簡単
- 既存コードへの影響が少ない

**適用ケース:**
- `ReservationService` ↔ `ReservationCommodityService` の循環参照
- `PaymentBusinessService` ↔ `ReservationCommodityService` の循環参照

**実装例:**
```php
// ReservationPaymentCoordinatorService
class ReservationPaymentCoordinatorService
{
    public function __construct(
        private readonly PaymentBusinessService $paymentService,
        private readonly ReservationCommodityService $commodityService,
    ) {}
    
    public function cancelCommodityReservation(int $id, FormRequest $request): void
    {
        // 両方のサービスを協調させる
    }
}
```

**影響範囲:**
- 循環参照が発生している箇所のみ
- コントローラー（中間サービスを使用するように変更）

**工数:** 小（1-2日、循環参照箇所のみ）

---

#### 4. **イベント駆動アーキテクチャ** ⭐
**優先度: 低（将来的な拡張性を考慮する場合）**

**理由:**
- 実装コストが高い
- 既存コードへの影響が大きい
- 現時点では過剰な可能性

**適用ケース:**
- 将来的に非同期処理が必要な場合
- 複数のサービスが同じイベントをリッスンする必要がある場合
- サービス間の結合度をさらに下げたい場合

**実装:**
- イベントクラスの作成
- イベントリスナーの登録
- 既存コードの大幅な変更

**影響範囲:**
- イベントを発火するすべてのサービス
- イベントをリッスンするすべてのサービス
- `EventServiceProvider`の設定

**工数:** 大（5-10日）

---

### ❌ Phase 3: 非推奨

#### 5. **遅延注入（Lazy Loading）** ❌
**優先度: 非推奨**

**理由:**
- テストが困難になる
- 依存関係が隠蔽される
- デバッグが難しくなる
- Laravel 11のベストプラクティスに反する

**代替案:**
- 中間サービスの導入
- イベント駆動アーキテクチャ

---

## 推奨実装順序

### Step 1: 基盤整備（必須）
1. ✅ `ServiceServiceProvider`を作成（完了）
2. ✅ `config/app.php`に登録
3. ✅ すべてのサービスをDIコンテナに登録

### Step 2: コンストラクタインジェクション（必須）
1. ✅ `ReservationService`のコンストラクタを変更
2. ✅ `ReservationCommodityService`のコンストラクタを変更
3. ✅ `PaymentBusinessService`のコンストラクタを変更
4. ✅ `DynamicPackageReservationService`のコンストラクタを変更
5. ✅ その他のサービスのコンストラクタを変更

### Step 3: 循環参照の確認と解決（必要に応じて）
1. ⚠️ 循環参照が発生しているか確認
2. ⚠️ 発生している場合、中間サービスを導入
3. ⚠️ テストで動作確認

### Step 4: イベント駆動（将来的に検討）
1. 📅 将来的に非同期処理が必要になった場合
2. 📅 サービス間の結合度をさらに下げたい場合

---

## 各アプローチの比較

| アプローチ | 優先度 | 工数 | 効果 | テスト容易性 | 推奨度 |
|---------|--------|------|------|------------|--------|
| DIコンテナ登録 | ⭐⭐⭐ | 中 | 高 | 高 | ✅ 必須 |
| コンストラクタインジェクション | ⭐⭐⭐ | 中 | 高 | 高 | ✅ 必須 |
| 中間サービス | ⭐⭐ | 小 | 中 | 高 | ✅ 推奨（循環参照時） |
| イベント駆動 | ⭐ | 大 | 高 | 中 | ⚠️ 将来的に検討 |
| 遅延注入 | - | 小 | 低 | 低 | ❌ 非推奨 |

---

## 具体的な実装計画

### Phase 1: 基盤整備（Week 1）

**Day 1-2: ServiceServiceProviderの設定**
- [ ] `config/app.php`に`ServiceServiceProvider`を登録
- [ ] 基盤サービス（`CacheService`, `LanguageService`など）を登録
- [ ] テストで動作確認

**Day 3-5: 主要サービスの移行**
- [ ] `PaymentBusinessService`のコンストラクタを変更
- [ ] `ReservationApiService`のコンストラクタを変更
- [ ] `ReservationLanguageService`のコンストラクタを変更
- [ ] テストで動作確認

### Phase 2: 主要サービスの移行（Week 2）

**Day 1-3: ReservationCommodityService**
- [ ] コンストラクタを変更
- [ ] `ServiceServiceProvider`に登録
- [ ] テストで動作確認

**Day 4-5: ReservationService**
- [ ] コンストラクタを変更
- [ ] `ServiceServiceProvider`に登録
- [ ] テストで動作確認

### Phase 3: 残りのサービス（Week 3）

**Day 1-2: DynamicPackageReservationService**
- [ ] コンストラクタを変更
- [ ] `ServiceServiceProvider`に登録
- [ ] テストで動作確認

**Day 3-5: その他のサービス**
- [ ] 残りのサービスのコンストラクタを変更
- [ ] テストで動作確認

### Phase 4: 循環参照の解決（必要に応じて）

**Day 1-2: 循環参照の確認**
- [ ] 循環参照が発生している箇所を特定
- [ ] 影響範囲を確認

**Day 3-5: 中間サービスの導入**
- [ ] 中間サービスを作成
- [ ] コントローラーを変更
- [ ] テストで動作確認

---

## 注意事項

### 1. 段階的な移行
- 一度にすべてを変更せず、段階的に移行
- 各フェーズで動作確認を実施

### 2. テストの重要性
- 各フェーズでユニットテストを追加
- 統合テストで全体の動作を確認

### 3. ロールバック計画
- 各フェーズでGitのブランチを作成
- 問題が発生した場合のロールバック手順を準備

### 4. パフォーマンス監視
- DIコンテナの使用によるパフォーマンスへの影響を監視
- 必要に応じて最適化

---

## まとめ

**本プロジェクトにおける推奨アプローチ:**

1. ✅ **DIコンテナ登録 + コンストラクタインジェクション**（必須）
   - すべてのサービスの基盤
   - テストしやすい設計の実現

2. ✅ **中間サービスの導入**（循環参照が発生した場合）
   - 実装が簡単
   - 既存コードへの影響が少ない

3. ⚠️ **イベント駆動アーキテクチャ**（将来的に検討）
   - 現時点では過剰な可能性
   - 非同期処理が必要になった場合に検討

4. ❌ **遅延注入**（非推奨）
   - テストが困難
   - ベストプラクティスに反する

**最優先で実装すべき:**
- DIコンテナ登録
- コンストラクタインジェクション

これらを実装することで、循環参照の問題を解決し、テストしやすい設計を実現できます。

