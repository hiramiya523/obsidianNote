# サービスクラスのディレクトリ構造とドメイン分離戦略

## 現状の問題点の分析

### フラットな構造がもたらす問題

**フラットな構造は循環参照の根本原因の一つです。**

```
app/Services/
├── ReservationService.php
├── ReservationCommodityService.php
├── PaymentBusinessService.php
├── PlanService.php
├── CommodityService.php
├── CourseChargeService.php
└── ... (55個以上のサービスがフラットに並ぶ)
```

**問題点:**
1. **責務の境界が曖昧** → どのサービスがどのドメインに属するか不明確
2. **依存関係が見えにくい** → 異なるドメインのサービスが直接依存しやすい
3. **循環参照が発生しやすい** → 境界がないため、適切な抽象化ができない
4. **保守性の低下** → 関連するサービスを見つけにくい、変更の影響範囲を把握しにくい

## 本プロジェクトにおける推奨分割案

### アプローチ: ドメイン駆動設計（DDD）に基づく分割

依存関係の分析から、以下のドメインが明確に識別できます。

### 推奨ディレクトリ構造

```
app/Services/
├── Core/                          # 基盤サービス（すべてのドメインから使用）
│   ├── CacheService.php
│   ├── LanguageService.php
│   ├── BlobService.php
│   ├── SnapshotService.php
│   ├── CancelPolicyService.php
│   ├── JwtService.php
│   ├── BearerTokenService.php
│   └── IdempotentService.php
│
├── Reservation/                   # 予約ドメイン
│   ├── ReservationService.php
│   ├── ReservationApiService.php
│   ├── ReservationCommodityService.php
│   ├── ReservationChargeTypeService.php
│   ├── ReservationLanguageService.php
│   ├── ReservationVerificationService.php
│   ├── DynamicPackageReservationService.php
│   ├── NorthDynamicPackageReservationService.php
│   └── ExtReservationInconsistencyService.php
│
├── Payment/                       # 決済ドメイン
│   └── PaymentBusinessService.php
│
├── Catalog/                       # カタログドメイン（プラン・商材・コース）
│   ├── Plan/
│   │   ├── PlanService.php
│   │   └── PlanRearrangementImageService.php
│   ├── Commodity/
│   │   ├── CommodityService.php
│   │   └── CommodityCalendarService.php
│   └── CourseCharge/
│       ├── CourseChargeService.php
│       ├── CourseChargeCalendarService.php
│       ├── CourseChargeCacheService.php
│       └── CourseStockCalendarService.php
│
├── Master/                        # マスタ管理ドメイン
│   ├── MasterApiService.php
│   ├── MasterChargeTypeService.php
│   ├── AgentService.php
│   ├── AreaService.php
│   ├── CategoryService.php
│   ├── HostCompanyService.php
│   ├── PlaceService.php
│   ├── SupplierService.php
│   ├── SupplierCompanyService.php
│   ├── UserService.php
│   ├── NoticeService.php
│   ├── PublicHolidayService.php
│   ├── PaymentMethodService.php
│   ├── ChargeTypeForCommodityService.php
│   ├── ChargeTypeForCourseService.php
│   ├── ModelCourseService.php
│   └── SentenceService.php
│
├── Customer/                      # 顧客向けドメイン（既存）
│   ├── CustomerPlanService.php
│   ├── CustomerReservationService.php
│   └── MemberService.php
│
├── External/                      # 外部APIドメイン（既存）
│   ├── RikishaApiService.php
│   ├── RikishaCacheService.php
│   └── TabioneApiService.php
│
├── ReservationMail/               # 予約メールドメイン（既存）
│   └── NorthReservationMailService.php
│
└── Infrastructure/                # インフラストラクチャサービス
    ├── ExcelService.php
    ├── PdfService.php
    ├── RosterService.php
    └── SanbashiService.php
```

## 各ドメインの詳細

### 1. Core（基盤サービス）

**責務:** すべてのドメインから使用される共通機能

**依存関係のルール:**
- 他のドメインのサービスに依存しない
- 他のドメインから依存される

**含まれるサービス:**
- `CacheService` - キャッシュ管理
- `LanguageService` - 言語管理
- `BlobService` - ファイル管理
- `SnapshotService` - スナップショット管理
- `CancelPolicyService` - キャンセルポリシー
- `JwtService` - JWT認証
- `BearerTokenService` - Bearerトークン認証
- `IdempotentService` - べき等性管理

### 2. Reservation（予約ドメイン）

**責務:** 予約に関する業務ロジック

**依存関係のルール:**
- `Core/` に依存可能
- `Payment/` に依存可能（決済処理）
- `External/` に依存可能（外部API）
- 他のドメイン（`Catalog/`, `Master/` など）には直接依存しない

**含まれるサービス:**
- `ReservationService` - 予約の基本操作
- `ReservationApiService` - 予約API操作
- `ReservationCommodityService` - 商材予約
- `ReservationChargeTypeService` - 予約料金タイプ
- `ReservationLanguageService` - 予約言語
- `ReservationVerificationService` - 予約検証
- `DynamicPackageReservationService` - DP予約
- `NorthDynamicPackageReservationService` - 北のDP予約
- `ExtReservationInconsistencyService` - 外部予約不整合

### 3. Payment（決済ドメイン）

**責務:** 決済に関する業務ロジック

**依存関係のルール:**
- `Core/` に依存可能
- `External/` に依存可能（外部決済API）
- 他のドメインには直接依存しない（予約ドメインから呼び出される）

**含まれるサービス:**
- `PaymentBusinessService` - 決済ビジネスロジック

### 4. Catalog（カタログドメイン）

**責務:** プラン・商材・コースに関する業務ロジック

#### 4.1 Plan（プランドメイン）

**依存関係のルール:**
- `Core/` に依存可能
- `CourseCharge/` に依存可能（料金計算）
- 他のドメインには直接依存しない

**含まれるサービス:**
- `PlanService` - プラン管理
- `PlanRearrangementImageService` - プラン画像再配置

#### 4.2 Commodity（商材ドメイン）

**依存関係のルール:**
- `Core/` に依存可能
- `Plan/` に依存可能（プラン情報）
- `CourseCharge/` に依存可能（料金計算）
- 他のドメインには直接依存しない

**含まれるサービス:**
- `CommodityService` - 商材管理
- `CommodityCalendarService` - 商材カレンダー

#### 4.3 CourseCharge（コース料金ドメイン）

**責務:** コース料金の計算と管理

**依存関係のルール:**
- `Core/` に依存可能
- `Plan/` に依存可能（プラン情報）
- `Reservation/` に依存可能（在庫計算のため、インターフェース経由）
- 他のドメインには直接依存しない

**含まれるサービス:**
- `CourseChargeService` - コース料金管理
- `CourseChargeCalendarService` - コース料金カレンダー
- `CourseChargeCacheService` - コース料金キャッシュ
- `CourseStockCalendarService` - コース在庫カレンダー

**注意:** `CourseStockCalendarService` が `ReservationCommodityService` に依存しているため、この依存関係を再考する必要があります。

### 5. Master（マスタ管理ドメイン）

**責務:** マスタデータの管理

**依存関係のルール:**
- `Core/` に依存可能
- 他のドメインには直接依存しない（マスタは独立）

**含まれるサービス:**
- `MasterApiService` - マスタAPI
- `MasterChargeTypeService` - マスタ料金タイプ
- `AgentService` - エージェント管理
- `AreaService` - エリア管理
- `CategoryService` - カテゴリ管理
- `HostCompanyService` - ホスト会社管理
- `PlaceService` - 場所管理
- `SupplierService` - サプライヤー管理
- `SupplierCompanyService` - サプライヤー会社管理
- `UserService` - ユーザー管理
- `NoticeService` - お知らせ管理
- `PublicHolidayService` - 祝日管理
- `PaymentMethodService` - 決済方法管理
- `ChargeTypeForCommodityService` - 商材料金タイプ
- `ChargeTypeForCourseService` - コース料金タイプ
- `ModelCourseService` - モデルコース管理
- `SentenceService` - 文章管理

### 6. Customer（顧客向けドメイン）

**責務:** 顧客向けの機能（既存）

**依存関係のルール:**
- 他のすべてのドメインに依存可能（顧客向け機能は統合的な機能）

**含まれるサービス:**
- `CustomerPlanService` - 顧客向けプラン
- `CustomerReservationService` - 顧客向け予約
- `MemberService` - メンバー管理

### 7. External（外部APIドメイン）

**責務:** 外部APIとの連携（既存）

**依存関係のルール:**
- `Core/` に依存可能
- 他のドメインには直接依存しない

**含まれるサービス:**
- `RikishaApiService` - 利休API
- `RikishaCacheService` - 利休キャッシュ
- `TabioneApiService` - Tabione API

### 8. ReservationMail（予約メールドメイン）

**責務:** 予約メールの送信（既存）

**依存関係のルール:**
- `Core/` に依存可能
- `Reservation/` に依存可能（予約情報）

**含まれるサービス:**
- `NorthReservationMailService` - 北の予約メール

### 9. Infrastructure（インフラストラクチャサービス）

**責務:** インフラストラクチャ関連のサービス

**依存関係のルール:**
- `Core/` に依存可能
- 他のドメインには直接依存しない

**含まれるサービス:**
- `ExcelService` - Excel操作
- `PdfService` - PDF操作
- `RosterService` - 名簿管理
- `SanbashiService` - 桟橋管理

## 依存関係のルール（重要）

### 階層構造と依存方向

```
Level 0: Core/                    # 基盤（依存なし）
  ↓
Level 1: External/, Master/       # 外部API・マスタ（Core のみ依存）
  ↓
Level 2: Catalog/                 # カタログ（Core, Master に依存）
  │   ├── Plan/
  │   ├── Commodity/
  │   └── CourseCharge/
  ↓
Level 3: Payment/                  # 決済（Core, External に依存）
  ↓
Level 4: Reservation/             # 予約（上記すべてに依存可能）
  ↓
Level 5: Customer/                # 顧客向け（統合的な機能）
```

### 依存関係の原則

1. **上位レベルのドメインは下位レベルのドメインに依存可能**
2. **下位レベルのドメインは上位レベルのドメインに依存してはいけない**
3. **同じレベルのドメイン間の依存は最小限に**
4. **循環参照は絶対に避ける**

### 例外的な依存関係の解決

#### 問題: CourseStockCalendarService → ReservationCommodityService

現在、`CourseCharge/CourseStockCalendarService` が `Reservation/ReservationCommodityService` に依存しています。

**解決策1: インターフェースの導入（推奨）**

```php
// Core/Contracts/ReservationStockCalculatorInterface.php
namespace App\Services\Core\Contracts;

interface ReservationStockCalculatorInterface
{
    public function calculateStock(MCommodity $commodity, string $date, ?int $agentCd): int;
}

// Reservation/ReservationCommodityService.php
namespace App\Services\Reservation;

use App\Services\Core\Contracts\ReservationStockCalculatorInterface;

class ReservationCommodityService implements ReservationStockCalculatorInterface
{
    public function calculateStock(MCommodity $commodity, string $date, ?int $agentCd): int
    {
        // 実装
    }
}

// Catalog/CourseCharge/CourseStockCalendarService.php
namespace App\Services\Catalog\CourseCharge;

use App\Services\Core\Contracts\ReservationStockCalculatorInterface;

class CourseStockCalendarService
{
    public function __construct(
        private readonly ReservationStockCalculatorInterface $stockCalculator,
    ) {}
}
```

**解決策2: 中間サービスの導入**

```php
// Catalog/CourseCharge/StockCalculationService.php
namespace App\Services\Catalog\CourseCharge;

use App\Services\Core\Contracts\ReservationStockCalculatorInterface;

class StockCalculationService
{
    public function __construct(
        private readonly ReservationStockCalculatorInterface $stockCalculator,
    ) {}
    
    public function calculateCourseStock(MCourse $course, string $date, int $agentCd): int
    {
        // CourseStockCalendarService のロジックをここに移動
    }
}
```

## 本プロジェクトにおける具体的な分割案

### 案1: ドメインごとに完全分割（推奨）

上記の構造を採用。各ドメインが明確に分離される。

**メリット:**
- 責務が明確
- 循環参照を回避しやすい
- 保守性が高い

**デメリット:**
- 移行コストが高い
- 名前空間の変更が必要

### 案2: 段階的な分割（現実的・推奨）

既存の `Customer/`, `External/`, `ReservationMail/` を活用しつつ、主要なドメインのみ分割。

```
app/Services/
├── Core/                    # 新規作成
├── Reservation/             # 新規作成
├── Payment/                 # 新規作成
├── Catalog/                  # 新規作成（Plan, Commodity, CourseCharge）
├── Master/                   # 新規作成
├── Customer/                # 既存
├── External/                # 既存
└── ReservationMail/         # 既存
```

**メリット:**
- 移行コストが低い
- 段階的に移行可能
- 実用的

**デメリット:**
- 完全な分離にはならない

### 案3: レイヤー分離（シンプル）

ドメインではなく、レイヤーで分離。

```
app/Services/
├── Infrastructure/          # インフラ層（Cache, Blob, Language など）
├── Domain/                  # ドメイン層（Reservation, Payment, Plan など）
├── Application/             # アプリケーション層（Customer など）
└── External/                # 外部連携層（既存）
```

**メリット:**
- シンプル
- 移行が容易

**デメリット:**
- ドメインの境界がまだ曖昧

## 推奨アプローチ

### 本プロジェクトには「案2: 段階的な分割」を推奨

**理由:**
1. 既存の構造（`Customer/`, `External/`）を活用できる
2. 移行コストが低い
3. 段階的に移行可能
4. 実用的

## 実装計画

### Phase 1: Core ドメインの作成（最優先）

**理由:** すべてのドメインから使用されるため、最初に分離することで依存関係が明確になる

1. `app/Services/Core/` ディレクトリを作成
2. 基盤サービスを移動
3. 名前空間を変更
4. `ServiceServiceProvider` を更新
5. すべての参照箇所を更新

**含まれるサービス:**
```
Core/
├── CacheService.php
├── LanguageService.php
├── BlobService.php
├── SnapshotService.php
├── CancelPolicyService.php
├── JwtService.php
├── BearerTokenService.php
└── IdempotentService.php
```

### Phase 2: Reservation ドメインの作成

**理由:** 循環参照の問題が発生している主要なドメイン

1. `app/Services/Reservation/` ディレクトリを作成
2. 予約関連サービスを移動
3. 名前空間を変更
4. 参照箇所を更新

**含まれるサービス:**
```
Reservation/
├── ReservationService.php
├── ReservationApiService.php
├── ReservationCommodityService.php
├── ReservationChargeTypeService.php
├── ReservationLanguageService.php
├── ReservationVerificationService.php
├── DynamicPackageReservationService.php
└── ...
```

### Phase 3: Payment ドメインの作成

**理由:** 独立したドメインで、他のドメインから呼び出される

1. `app/Services/Payment/` ディレクトリを作成
2. `PaymentBusinessService` を移動
3. 名前空間を変更
4. 参照箇所を更新

**含まれるサービス:**
```
Payment/
└── PaymentBusinessService.php
```

### Phase 4: Catalog ドメインの作成

**理由:** 関連するサービスをまとめることで、依存関係が明確になる

1. `app/Services/Catalog/` ディレクトリを作成
2. `Plan/`, `Commodity/`, `CourseCharge/` サブディレクトリを作成
3. 各サービスを移動
4. 名前空間を変更
5. 参照箇所を更新

**含まれるサービス:**
```
Catalog/
├── Plan/
│   ├── PlanService.php
│   └── PlanRearrangementImageService.php
├── Commodity/
│   ├── CommodityService.php
│   └── CommodityCalendarService.php
└── CourseCharge/
    ├── CourseChargeService.php
    ├── CourseChargeCalendarService.php
    ├── CourseChargeCacheService.php
    └── CourseStockCalendarService.php
```

### Phase 5: Master ドメインの作成

**理由:** 他のドメインに依存しない独立したドメイン

1. `app/Services/Master/` ディレクトリを作成
2. マスタ関連サービスを移動
3. 名前空間を変更
4. 参照箇所を更新

## 依存関係のルール（deptrac.yaml での強制）

ディレクトリ構造を変更した後、`deptrac.yaml` で依存関係を強制できます：

```yaml
ruleset:
  # Core は他のドメインに依存しない
  Core:
    - Laravel
    - Vendor
  
  # External は Core のみに依存
  External:
    - Core
    - Laravel
    - Vendor
  
  # Master は Core のみに依存
  Master:
    - Core
    - Laravel
    - Vendor
  
  # Catalog は Core, Master に依存可能
  Catalog:
    - Core
    - Master
    - Laravel
    - Vendor
  
  # Payment は Core, External に依存可能
  Payment:
    - Core
    - External
    - Laravel
    - Vendor
  
  # Reservation は上記すべてに依存可能
  Reservation:
    - Core
    - External
    - Master
    - Catalog
    - Payment
    - Laravel
    - Vendor
  
  # Customer はすべてに依存可能（統合的な機能）
  Customer:
    - Core
    - External
    - Master
    - Catalog
    - Payment
    - Reservation
    - Laravel
    - Vendor
```

## 移行時の注意事項

### 1. 名前空間の変更

```php
// Before
namespace App\Services;

// After
namespace App\Services\Reservation;
```

### 2. すべての参照箇所を更新

- コントローラー
- 他のサービス
- テスト
- ファクトリー
- シーダー
- `ServiceServiceProvider`

### 3. 自動リファクタリングツールの活用

```bash
# PHPStorm の Refactor → Move 機能を使用
# または、PHPStan や Laravel IDE Helper を使用
```

### 4. 段階的な移行

一度にすべてを変更せず、段階的に移行することを推奨します。

### 5. テストの重要性

各フェーズでユニットテストを追加し、統合テストで全体の動作を確認してください。

## メリット

### 1. 責務の明確化

- 各ドメインの責務が明確になる
- どのサービスがどのドメインに属するか一目瞭然

### 2. 循環参照の回避

- ドメイン間の依存関係が明確になる
- 依存関係のルールを強制できる

### 3. 保守性の向上

- 関連するサービスが同じディレクトリに集約される
- 変更の影響範囲を把握しやすい

### 4. テストの容易さ

- ドメインごとにテストを分離できる
- モックの注入が容易になる

## まとめ

**フラットな構造は確かに問題の原因です。**

ドメインごとにディレクトリを分割することで：

1. ✅ **責務が明確になる** - どのサービスがどのドメインに属するか一目瞭然
2. ✅ **循環参照を回避できる** - ドメイン間の依存関係が明確になり、ルールを強制できる
3. ✅ **保守性が向上する** - 関連するサービスが同じディレクトリに集約される
4. ✅ **テストが容易になる** - ドメインごとにテストを分離できる

**推奨:** 段階的な分割（案2）を採用し、まずは `Core/` と `Reservation/` ドメインから始めることをお勧めします。

