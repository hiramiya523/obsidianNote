---
title: 一方向依存関係のルール強制方法
created: 2025-12-03
updated: 2025-12-03
category: Laravel
tags:
  - laravel
  - php
  - deptrac
  - phpstan
  - アーキテクチャ
  - 循環参照
  - 依存関係
aliases:
  - 依存関係ルール
  - Deptrac設定
---

# 一方向依存関係のルール強制方法

## 概要

PHPStanとDeptracを使用して、サービス間の一方向依存関係を強制する方法を説明します。

## 1. Deptracによる一方向依存の強制 ✅ 推奨

Deptracはアーキテクチャの依存関係を検証する専用ツールで、**一方向依存を強制するのに最適**です。

### 現在の設定の問題点

現在の`deptrac.yaml`では、各サービスが依存できるサービスをリストアップしていますが、**循環参照を防ぐ階層構造**が定義されていません。

### 解決策：レイヤー階層の定義

#### 方法1: ドメイン別レイヤー（推奨）

```yaml
deptrac:
  layers:
    # レイヤー階層を定義（下から上への依存のみ許可）
    - name: Core
      collectors:
        - type: directory
          value: app/Services/Core
    
    - name: ReservationCore
      collectors:
        - type: directory
          value: app/Services/Reservation/Core
    
    - name: ReservationApi
      collectors:
        - type: directory
          value: app/Services/Reservation/Api
    
    - name: ReservationCommodity
      collectors:
        - type: directory
          value: app/Services/Reservation/Commodity
    
    - name: Payment
      collectors:
        - type: directory
          value: app/Services/Payment
    
    - name: Catalog
      collectors:
        - type: directory
          value: app/Services/Catalog
    
    - name: Master
      collectors:
        - type: directory
          value: app/Services/Master

  ruleset:
    # 一方向依存のルール
    # 下のレイヤーは上のレイヤーに依存できない
    Core:
      - Models
      - Components
      - Laravel
      - Vendor
    
    ReservationCore:
      - Core
      - Models
      - Components
      - Laravel
      - Vendor
    
    ReservationApi:
      - ReservationCore  # 一方向依存
      - Core
      - Models
      - Components
      - Laravel
      - Vendor
    
    ReservationCommodity:
      - ReservationApi  # 一方向依存
      - ReservationCore
      - Core
      - Models
      - Components
      - Laravel
      - Vendor
    
    Payment:
      - Core
      - Models
      - Components
      - Laravel
      - Vendor
    
    Catalog:
      - Core
      - Models
      - Components
      - Laravel
      - Vendor
    
    Master:
      - Core
      - Models
      - Components
      - Laravel
      - Vendor
```

#### 方法2: 個別サービスでの一方向依存ルール

現在の個別サービス定義を維持しつつ、循環参照を防ぐルールを追加：

```yaml
deptrac:
  ruleset:
    # 循環参照を防ぐための一方向依存ルール
    
    # Core層（最下層）
    CacheService:
      - Laravel
      - Vendor
    
    LanguageService:
      - Models
      - Laravel
      - Vendor
    
    # Reservation層（Core層に依存）
    ReservationService:
      - PaymentBusinessService
      - CancelPolicyService
      - BlobService
      - ReservationChargeTypeService
      - ReservationLanguageService
      - CustomerPlanService
      - RikishaApiService
      - Models
      - Components
      - Laravel
      - Vendor
      # 注意: ReservationApiService への依存は禁止（循環参照）
      # 注意: ReservationVerificationService への依存は禁止（循環参照）
    
    ReservationApiService:
      - ReservationCommodityService
      - SnapshotService
      - ReservationChargeTypeService
      - Models
      - Components
      - Laravel
      - Vendor
      # 注意: ReservationService への依存は禁止（循環参照）
      # 注意: DynamicPackageReservationService への依存は禁止（循環参照）
    
    ReservationVerificationService:
      - ReservationService  # 許可（一方向）
      - MasterChargeTypeService
      - CourseChargeCalendarService
      - ReservationCommodityService
      - PlanService
      - Models
      - Laravel
      - Vendor
    
    DynamicPackageReservationService:
      - ReservationService  # 許可（一方向）
      - ReservationApiService  # 許可（一方向）
      - PaymentBusinessService
      - ReservationLanguageService
      - CustomerPlanService
      - RikishaApiService
      - Models
      - Components
      - Laravel
      - Vendor
```

### 循環参照の検出

Deptracは循環参照を自動的に検出します：

```bash
# 循環参照を検出
vendor/bin/deptrac analyze

# 違反がある場合の出力例:
# [VIOLATION] ReservationService must not depend on ReservationApiService
# [VIOLATION] ReservationApiService must not depend on ReservationService
```

## 2. PHPStanによる検証（限定的）

PHPStanは主に型チェックに特化しており、**アーキテクチャの依存関係を強制する機能は限定的**です。

### 可能な検証

1. **型の存在確認**
   - 存在しないクラスへの依存を検出
   - 型の不整合を検出

2. **カスタムルール（PHPStan Extension）**
   - カスタムルールを作成して依存関係を検証可能
   - ただし、実装が複雑

### 推奨しない理由

- PHPStanは型チェックに特化
- アーキテクチャルールの実装が複雑
- Deptracの方が適切

## 3. 実装例

### ステップ1: 現在の循環参照を確認

```bash
# Deptracで現在の違反を確認
vendor/bin/deptrac analyze
```

### ステップ2: レイヤー階層を定義

上記の方法1または方法2を使用して、レイヤー階層を定義。

### ステップ3: ルールを段階的に適用

1. まず、循環参照を検出
2. 違反を修正
3. ルールを厳格化

### ステップ4: CI/CDに組み込む

```yaml
# .github/workflows/ci.yml
- name: Check Architecture
  run: composer deptrac:check
```

## 4. 実践的なアプローチ

### 段階的な導入

1. **Phase 1: 循環参照の検出**
   - 現在の循環参照を検出
   - 違反をリストアップ

2. **Phase 2: ルールの緩和**
   - 既存の循環参照を許可（`skip_violations`）
   - 新規の循環参照を禁止

3. **Phase 3: 段階的な修正**
   - 既存の循環参照を1つずつ修正
   - ルールを厳格化

### 設定例（段階的導入）

```yaml
deptrac:
  ruleset:
    ReservationService:
      - PaymentBusinessService
      - CancelPolicyService
      # ... 他の依存
    
  skip_violations:
    # 既存の循環参照を一時的に許可
    - 'ReservationService must not depend on ReservationApiService'
    - 'ReservationApiService must not depend on ReservationService'
```

## 5. メリット・デメリット

### Deptracのメリット

✅ **一方向依存を強制可能**
✅ **循環参照を自動検出**
✅ **CI/CDに組み込み可能**
✅ **視覚的なレポート生成**

### デメリット

❌ **設定が複雑**
❌ **既存コードの大幅な修正が必要な場合がある**
❌ **学習コスト**

## 6. 推奨事項

1. **Deptracを使用して一方向依存を強制**
   - レイヤー階層を定義
   - 段階的にルールを適用

2. **PHPStanは型チェックに専念**
   - アーキテクチャルールはDeptracに任せる

3. **段階的な導入**
   - 既存の循環参照を許可
   - 新規の循環参照を禁止
   - 段階的に修正

## 7. 参考リンク

- [Deptrac公式ドキュメント](https://qossmic.github.io/deptrac/)
- [Deptracのレイヤー定義](https://qossmic.github.io/deptrac/0.24/layers.html)
- [Deptracのルールセット](https://qossmic.github.io/deptrac/0.24/rulesets.html)

## 関連ドキュメント

- [[Laravel/Coordinatorパターンの実装とコントローラーへの影響|Coordinatorパターンの実装とコントローラーへの影響]] - 循環参照解決の実装パターン
- [[Laravel/CoordinatorとMediatorパターンの違い|CoordinatorとMediatorパターンの違い]] - パターンの比較
- [[Projects/予約ドメインの循環参照解決とサブドメイン分割戦略|予約ドメインの循環参照解決とサブドメイン分割戦略]] - 循環参照解決の全体戦略
- [[Laravel/サービス依存関係リファクタリング計画|サービス依存関係リファクタリング計画]] - リファクタリング計画
- [[Index|ホーム]] - 目次に戻る



