---
title: テストカバレッジ改善計画
created: 2025-12-02
updated: 2025-12-02
tags:
  - testing
  - code-coverage
  - phpunit
  - laravel
  - project-plan
aliases:
  - テストカバレッジ
  - Code Coverage
  - テスト改善
---

# テストカバレッジ改善計画

> [!abstract] 概要
> PJのテストカバレッジを4%から80%以上に向上させるための包括的な改善計画です。
> 
> **現状**: Lines 4.00% (785/19,624行)  
> **目標**: Lines 80%以上（1年後）

---

## 📋 目次

- [[#カバレッジ指標の理解|カバレッジ指標の理解]]
- [[#現状のカバレッジ分析|現状のカバレッジ分析]]
- [[#改善戦略|改善戦略]]
- [[#具体的なアクションプラン|具体的なアクションプラン]]
- [[#テスト作成のベストプラクティス|テスト作成のベストプラクティス]]
- [[#カバレッジ目標の設定|カバレッジ目標の設定]]
- [[#注意点とリスク|注意点とリスク]]

---

## 📊 カバレッジ指標の理解

### 3つの主要指標

テストカバレッジレポートには、3つの主要な指標があります。それぞれ異なる観点からコードのテスト状況を表しています。

| 指標 | 定義 | 現在の値 | 目標（1年後） |
|------|------|---------|--------------|
| **Lines（行）** | 実行されたコード行の割合 | 4.00% (785/19,624行) | 80%以上 |
| **Functions/Methods（関数・メソッド）** | 呼び出された関数・メソッドの割合 | 5.98% (102/1,705個) | 85%以上 |
| **Classes/Traits（クラス・トレイト）** | 使用されたクラス・トレイトの割合 | 5.38% (21/390個) | 90%以上 |

### 指標の階層構造

```
Classes/Traits (クラス・トレイトレベル)
    ↓
Functions/Methods (関数・メソッドレベル)
    ↓
Lines (コード行レベル)
```

### 現在のプロジェクトの状況分析

```
Lines: 4.00% (785 / 19,624行)
Functions/Methods: 5.98% (102 / 1,705個)
Classes/Traits: 5.38% (21 / 390個)
```

> [!info] 分析結果
> - 3つの指標が**ほぼ同じレベル**（4-6%）
> - これは**全体的にテストが不足している**ことを示している
> - 特定の領域だけがテストされているわけではなく、**全体的にテストが少ない**
> - テストされているクラス・メソッド・コード行が**バランス良く**テストされている
> - ただし、**全体のテスト量が非常に少ない**

### どの指標を重視すべきか

> [!tip] 推奨アプローチ
> 1. **Lines（行カバレッジ）を主要指標とする**
>    - 最も詳細な情報を提供
>    - 最も一般的な指標
>    - 目標設定がしやすい
> 
> 2. **Functions/Methodsを補助指標とする**
>    - 関数・メソッド単位での改善状況を把握
>    - 未テストの関数・メソッドを特定
> 
> 3. **Classes/Traitsを参考指標とする**
>    - アーキテクチャレベルの問題を把握
>    - 未テストのクラス・トレイトを特定

詳細な指標の説明については、[[テストカバレッジ指標の説明]]を参照してください。

---

## 📊 現状のカバレッジ分析

### 全体のカバレッジ状況

| 指標 | カバレッジ | 詳細 |
|------|-----------|------|
| **Lines（行）** | **4.00%** | 785 / 19,624行 |
| **Functions/Methods（関数・メソッド）** | **5.98%** | 102 / 1,705個 |
| **Classes/Traits（クラス・トレイト）** | **5.38%** | 21 / 390個 |

> [!warning] 評価
> **非常に低いカバレッジ。緊急の改善が必要**

### ディレクトリ別のカバレッジ詳細

| ディレクトリ | Lines | Functions | Classes | 評価 | 優先度 |
|------------|-------|-----------|---------|------|--------|
| **helpers** | 63.08% | 20.00% | n/a | ✅ 良好 | 低 |
| **Exceptions** | 45.83% | 50.00% | 42.86% | ✅ 比較的良好 | 低 |
| **Enums** | 34.79% | 31.96% | 29.55% | ⚠️ 改善の余地あり | 中 |
| **Models** | 31.57% | 12.81% | 3.39% | ⚠️ 改善が必要 | **高** |
| **Factory** | 21.74% | 14.29% | 14.29% | ⚠️ 改善が必要 | 中 |
| **Traits** | 10.85% | 12.50% | 7.69% | ⚠️ 改善が必要 | 中 |
| **Services** | **2.27%** | 4.77% | 0.00% | ❌ **非常に低い** | **最高** |
| **Http (Controllers)** | **1.07%** | 0.73% | 0.65% | ❌ **非常に低い** | **最高** |
| **Gates** | **1.04%** | 0.00% | 0.00% | ❌ **非常に低い** | **高** |
| **Components** | **0.42%** | 1.68% | 0.00% | ❌ **非常に低い** | **高** |
| **Rules** | 0.00% | 0.00% | 0.00% | ❌ 未テスト | 中 |
| **Notifications** | 0.00% | 0.00% | 0.00% | ❌ 未テスト | 中 |
| **Mail** | 0.00% | 0.00% | 0.00% | ❌ 未テスト | 中 |
| **Logging** | 0.00% | 0.00% | 0.00% | ❌ 未テスト | 低 |
| **Jobs** | 0.00% | 0.00% | 0.00% | ❌ 未テスト | 中 |

### 重要な発見

> [!important] 最優先で改善が必要な領域
> 
> 1. **Servicesディレクトリが最大の問題**
>    - カバレッジ: 2.27% (289/12,743行)
>    - **コード量が最も多い**（12,743行）
>    - ビジネスロジックの中核部分
>    - **最優先で改善が必要**
> 
> 2. **Controllersが未テスト**
>    - カバレッジ: 1.07% (31/2,902行)
>    - APIエンドポイントのテストが不足
>    - ユーザーインターフェースのテストが不足
> 
> 3. **Gatesが未テスト**
>    - カバレッジ: 1.04% (4/386行)
>    - 認可ロジックのテストが不足
>    - セキュリティリスク
> 
> 4. **Components（API Client）が未テスト**
>    - カバレッジ: 0.42% (8/1,890行)
>    - 外部API連携のテストが不足
>    - 統合テストが必要

---

## 🎯 改善戦略

### フェーズ1: 緊急対応（1-2ヶ月）

**目標：** カバレッジを4% → 20%に向上

#### 1. Servicesディレクトリのテスト追加（最優先）

**理由：**
- コード量が最も多い（12,743行）
- ビジネスロジックの中核
- バグの影響が大きい

**推奨アプローチ：**

```php
// 例: ReservationServiceのテスト
// tests/Unit/Services/ReservationServiceTest.php

use Tests\TestCase;
use App\Services\ReservationService;
use Illuminate\Foundation\Testing\RefreshDatabase;

class ReservationServiceTest extends TestCase
{
    use RefreshDatabase;

    public function test_create_reservation_success()
    {
        // Arrange
        $service = new ReservationService();
        $data = [
            'user_id' => 1,
            'plan_id' => 1,
            // ... 必要なデータ
        ];

        // Act
        $result = $service->create($data);

        // Assert
        $this->assertNotNull($result);
        $this->assertDatabaseHas('reservations', [
            'id' => $result->id
        ]);
    }

    public function test_create_reservation_validation_error()
    {
        // バリデーションエラーのテスト
    }

    public function test_cancel_reservation_success()
    {
        // キャンセル処理のテスト
    }
}
```

**優先順位：**
1. **ReservationService**（予約関連）
2. **PaymentBusinessService**（決済関連）
3. **CourseChargeCalendarService**（料金計算）
4. **CourseStockCalendarService**（在庫管理）

**目標：** Servicesディレクトリを2.27% → 30%以上に向上

#### 2. Controllersのテスト追加

**理由：**
- APIエンドポイントの動作確認
- リクエスト/レスポンスの検証
- エラーハンドリングの確認

**推奨アプローチ：**

```php
// 例: ReservationControllerのテスト
// tests/Feature/Http/Controllers/ReservationControllerTest.php

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use App\Models\User;

class ReservationControllerTest extends TestCase
{
    use RefreshDatabase;

    public function test_index_returns_reservations()
    {
        // Arrange
        $user = User::factory()->create();
        $this->actingAs($user);

        // Act
        $response = $this->getJson('/api/reservations');

        // Assert
        $response->assertStatus(200)
            ->assertJsonStructure([
                'data' => [
                    '*' => ['id', 'user_id', 'status']
                ]
            ]);
    }

    public function test_store_creates_reservation()
    {
        // 予約作成のテスト
    }

    public function test_show_returns_reservation()
    {
        // 予約詳細取得のテスト
    }
}
```

**優先順位：**
1. **ReservationController**（予約関連）
2. **Auth/LoginController**（認証）
3. **Customer/Auth/MemberLoginController**（会員認証）

**目標：** Controllersのカバレッジを1.07% → 25%以上に向上

#### 3. Gatesのテスト追加

**理由：**
- 認可ロジックの検証
- セキュリティの確保

**推奨アプローチ：**

```php
// 例: ReservationGateのテスト
// tests/Unit/Gates/ReservationGateTest.php

use Tests\TestCase;
use App\Gates\ReservationGate;
use App\Models\User;
use App\Models\Reservation;

class ReservationGateTest extends TestCase
{
    public function test_user_can_view_own_reservation()
    {
        // Arrange
        $user = User::factory()->create();
        $reservation = Reservation::factory()->create(['user_id' => $user->id]);

        // Act & Assert
        $this->assertTrue(
            ReservationGate::view($user, $reservation)
        );
    }

    public function test_user_cannot_view_other_reservation()
    {
        // 他人の予約は見られない
    }
}
```

**目標：** Gatesのカバレッジを1.04% → 50%以上に向上

---

### フェーズ2: 基盤強化（2-3ヶ月）

**目標：** カバレッジを20% → 50%に向上

#### 1. Modelsのテスト追加

**現状：** 31.57% → **目標：60%以上**

**推奨アプローチ：**

```php
// 例: TReservationモデルのテスト
// tests/Unit/Models/Reservation/TReservationTest.php

use Tests\TestCase;
use App\Models\Reservation\TReservation;
use Illuminate\Foundation\Testing\RefreshDatabase;

class TReservationTest extends TestCase
{
    use RefreshDatabase;

    public function test_total_charge_calculation()
    {
        // 合計金額の計算ロジックのテスト
    }

    public function test_status_transition()
    {
        // ステータス遷移のテスト
    }

    public function test_scopes()
    {
        // スコープのテスト
    }
}
```

#### 2. Components（API Client）のテスト追加

**現状：** 0.42% → **目標：40%以上**

**推奨アプローチ：**

```php
// 例: RikishaApiClientのテスト
// tests/Unit/Components/ApiClient/RikishaApiClientTest.php

use Tests\TestCase;
use App\Components\ApiClient\RikishaApiClient;
use Illuminate\Support\Facades\Http;

class RikishaApiClientTest extends TestCase
{
    public function test_fetch_availability_list_success()
    {
        // Arrange
        Http::fake([
            'rikisha-api.com/*' => Http::response([
                'status' => 'success',
                'data' => []
            ], 200)
        ]);

        $client = new RikishaApiClient();

        // Act
        $result = $client->fetchAvailabilityList([]);

        // Assert
        $this->assertNotNull($result);
    }

    public function test_fetch_availability_list_error()
    {
        // エラーハンドリングのテスト
    }
}
```

**注意点：**
- 外部APIのモックが必要
- HTTPクライアントのモック（Guzzle等）
- エラーレスポンスのテスト

#### 3. Rulesのテスト追加

**現状：** 0.00% → **目標：70%以上**

**推奨アプローチ：**

```php
// 例: バリデーションルールのテスト
// tests/Unit/Rules/CustomRuleTest.php

use Tests\TestCase;
use App\Rules\CustomRule;

class CustomRuleTest extends TestCase
{
    public function test_rule_passes()
    {
        $rule = new CustomRule();
        $this->assertTrue($rule->passes('attribute', 'value'));
    }

    public function test_rule_fails()
    {
        $rule = new CustomRule();
        $this->assertFalse($rule->passes('attribute', 'invalid'));
    }
}
```

---

### フェーズ3: 完全性の追求（3-6ヶ月）

**目標：** カバレッジを50% → 80%以上に向上

#### 1. 残りのディレクトリのテスト追加

- **Mail**: メール送信のテスト
- **Notifications**: 通知のテスト
- **Jobs**: ジョブのテスト
- **Logging**: ロギングのテスト

#### 2. 統合テストの追加

- APIエンドポイントの統合テスト
- 外部API連携の統合テスト
- データベース操作の統合テスト

#### 3. E2Eテストの検討

- 主要なユーザーフローのテスト
- ブラウザテスト（Laravel Dusk等）

---

## 📋 具体的なアクションプラン

### 即座に実施すべきこと（今週中）

1. **テストカバレッジの目標設定**
   ```bash
   # 目標: 3ヶ月で20%、6ヶ月で50%、1年で80%
   ```

2. **テスト実行の自動化**
   ```yaml
   # .gitlab-ci.ymlに追加
   test-coverage:
     stage: test
     script:
       - composer test-coverage
     artifacts:
       paths:
         - temp/coverage/
       expire_in: 30 days
   ```

3. **カバレッジレポートの定期確認**
   - 週次でカバレッジレポートを確認
   - カバレッジが下がった場合は即座に対応

### 1ヶ月以内に実施すべきこと

1. **Servicesディレクトリのテスト追加**
   - ReservationServiceのテスト
   - PaymentBusinessServiceのテスト
   - 最低でも5つのServiceクラスにテストを追加

2. **Controllersのテスト追加**
   - ReservationControllerのテスト
   - AuthControllerのテスト
   - 最低でも3つのControllerにテストを追加

3. **テストガイドラインの作成**
   - テストの書き方の標準化
   - テストデータの準備方法
   - モックの使い方

### 3ヶ月以内に実施すべきこと

1. **カバレッジ20%達成**
   - Services: 30%以上
   - Controllers: 25%以上
   - Models: 50%以上

2. **CI/CDパイプラインの改善**
   - カバレッジ閾値の設定
   - カバレッジが下がった場合の警告

3. **テストのリファクタリング**
   - 重複コードの削減
   - テストヘルパーの作成
   - テストデータファクトリーの活用

---

## 🛠️ テスト作成のベストプラクティス

### 1. AAAパターンの使用

```php
public function test_example()
{
    // Arrange: テストデータの準備
    $user = User::factory()->create();
    
    // Act: テスト対象の実行
    $result = $service->doSomething($user);
    
    // Assert: 結果の検証
    $this->assertNotNull($result);
}
```

### 2. テストの独立性

- 各テストは独立して実行可能であること
- テストの実行順序に依存しないこと
- データベースの状態をリセットすること（RefreshDatabase）

### 3. テストの命名規則

```php
// 良い例
public function test_create_reservation_success()
public function test_create_reservation_validation_error()
public function test_cancel_reservation_with_refund()

// 悪い例
public function test1()
public function test_reservation()
public function test_ok()
```

### 4. モックの適切な使用

```php
// 外部APIのモック
Http::fake([
    'external-api.com/*' => Http::response(['data' => 'test'], 200)
]);

// サービスのモック
$mockService = Mockery::mock(Service::class);
$mockService->shouldReceive('method')->once()->andReturn('result');
```

### 5. テストデータの準備

```php
// Factoryの活用
$user = User::factory()->create();
$reservation = Reservation::factory()->create(['user_id' => $user->id]);

// 必要なデータのみ作成
$reservation = Reservation::factory()->state([
    'status' => 'confirmed',
    'total_amount' => 10000
])->create();
```

---

## 📊 カバレッジ目標の設定

### 段階的な目標設定

| 期間 | 目標カバレッジ | 重点領域 |
|------|--------------|---------|
| **1ヶ月後** | 10% | Services, Controllers |
| **3ヶ月後** | 20% | Services, Controllers, Gates |
| **6ヶ月後** | 50% | 全領域 |
| **1年後** | 80% | 完全性の追求 |

### ディレクトリ別の目標

| ディレクトリ | 現状 | 3ヶ月後 | 6ヶ月後 | 1年後 |
|------------|------|--------|--------|------|
| **Services** | 2.27% | 30% | 60% | 85% |
| **Controllers** | 1.07% | 25% | 50% | 80% |
| **Gates** | 1.04% | 50% | 70% | 90% |
| **Models** | 31.57% | 50% | 70% | 85% |
| **Components** | 0.42% | 20% | 40% | 70% |
| **Rules** | 0.00% | 50% | 70% | 90% |

### 指標別の目標設定

| 期間 | Lines | Functions/Methods | Classes/Traits |
|------|-------|------------------|----------------|
| **3ヶ月後** | 20% | 25% | 30% |
| **6ヶ月後** | 50% | 55% | 60% |
| **1年後** | 80% | 85% | 90% |

> [!note] 注意
> Classes/Traitsの目標を少し高めに設定する理由：
> - クラス全体が使用されれば、そのクラスはカバーされたとカウントされる
> - ただし、クラス内のすべてのメソッドがテストされているわけではない

---

## ⚠️ 注意点とリスク

### 1. カバレッジの罠

> [!warning] 重要な注意点
> - **カバレッジ100%が目標ではない**
>   - 意味のあるテストを書くことが重要
>   - カバレッジだけを追うと、無意味なテストが増える
> 
> - **テストの品質が重要**
>   - テストが正しく動作しているか
>   - テストが保守可能か
>   - テストが理解しやすいか

### 2. テストの優先順位

**最優先：**
- ビジネスロジック（Services）
- クリティカルパス（予約、決済）
- セキュリティ関連（Gates、認証）

**次に優先：**
- APIエンドポイント（Controllers）
- データモデル（Models）
- 外部連携（Components）

**低優先度：**
- ユーティリティ関数
- ヘルパー関数
- ロギング

### 3. テストの実行時間

- テストの実行時間を考慮
- 並列実行の検討
- テストの最適化

---

## 🎯 次のステップ

### 今すぐできること

1. **カバレッジレポートの共有**
   - チーム内で現状を共有
   - 改善計画を立てる

2. **テストの優先順位付け**
   - クリティカルパスの特定
   - テストすべき機能のリストアップ

3. **テストガイドラインの作成**
   - テストの書き方の標準化
   - コードレビューでの確認項目

### 1週間以内に実施

1. **最初のテストを書く**
   - ReservationServiceのテスト
   - ReservationControllerのテスト

2. **CI/CDパイプラインの改善**
   - カバレッジレポートの自動生成
   - カバレッジの可視化

3. **テスト実行の習慣化**
   - プルリクエスト前にテストを実行
   - テストが通らない場合はマージしない

---

## 📚 参考資料

- [PHPUnit Documentation](https://phpunit.de/documentation.html)
- [Laravel Testing Documentation](https://laravel.com/docs/11.x/testing)
- [Test-Driven Development (TDD)](https://en.wikipedia.org/wiki/Test-driven_development)
- [Code Coverage Best Practices](https://www.atlassian.com/continuous-delivery/software-testing/code-coverage)

---

## 関連ノート

- [[テストカバレッジ指標の説明]] - カバレッジ指標の詳細な説明
- [[AI開発移行計画]] - Phase 1でテスト基盤の構築が重要
- [[Sveltekit導入計画]]

